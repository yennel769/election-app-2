<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Overrides Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    :root{
      --blue:#0b3d91;   /* flag blue */
      --red:#b22234;    /* flag red */
      --ink:#222;
      --muted:#6b7280;
      --bg:#f5f7fb;
      --card:#ffffff;
      --line:#e5e7eb;
      --btn:#0b3d91;
      --btnText:#fff;
      --btnSub:#e2e8f0;
      --focus:#2563eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }
    .container{
      max-width: 980px;
      margin: 28px auto 60px;
      padding: 0 16px;
    }

    /* Header */
    .titlebar{
      background: linear-gradient(90deg, var(--blue), var(--red));
      color:#fff;
      padding:14px 18px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
    }
    .titlebar h1{
      font-size:18px;
      font-weight:700;
      letter-spacing:.2px;
      margin:0;
    }
    .titlebar .right{
      display:flex;
      gap:8px;
      align-items:center;
    }

    /* Card */
    .card{
      margin-top:16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow: 0 6px 24px rgba(0,0,0,.05);
      padding:16px;
    }

    /* Grid form */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }
    .col-6{ grid-column: span 6; }
    .col-12{ grid-column: span 12; }

    label{
      display:block;
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:6px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    select, input{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      color:var(--ink);
      font-size:14px;
      outline:none;
    }
    select:focus, input:focus{
      border-color:var(--focus);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .btn{
      appearance:none;
      border:none;
      background:var(--btn);
      color:var(--btnText);
      font-weight:600;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(11,61,145,.25);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{
      background:#fff;
      color:var(--ink);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.ghost{
      background:var(--btnSub);
      color:var(--ink);
      box-shadow:none;
    }

    .row-actions{
      display:flex;
      gap:10px;
      margin-top:8px;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:8px;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      text-transform:uppercase;
      letter-spacing:.2px;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
      font-size:14px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid var(--line);
      font-size:12px;
      font-weight:600;
      color:#111827;
    }
    .pill-blue{ background:#eef2ff; border-color:#dbeafe; color:#1e3a8a; }
    .pill-red{ background:#fff1f2; border-color:#ffe4e6; color:#991b1b; }
    .muted{ color:var(--muted); }
    
    select:disabled { background:#f3f4f6; color:#9ca3af; cursor:not-allowed; }

    @media (max-width: 720px){
      .col-4,.col-3{ grid-column: span 6; }
      .col-6{ grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="titlebar">
      <h1>Overrides Admin</h1>
      <div class="right">
        <button id="refresh" class="btn secondary">Refresh</button>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="col-3">
          <label>Race</label>
          <select id="officeSel">
            <option value="P">President (P)</option>
            <option value="S">Senate (S)</option>
            <option value="G">Governor (G)</option>
            <option value="H">House (H)</option>
          </select>
        </div>

        <div class="col-3">
          <label>Type</label>
          <select id="typeSel">
            <option value="G">General</option>
            <option value="D">DEM Primary</option>
            <option value="R">REP Primary</option>
          </select>
        </div>

        <div class="col-3">
          <label>State</label>
          <select id="stateSel"></select>
        </div>

        <div class="col-3" id="districtWrap" style="display:none;">
          <label>District</label>
          <select id="districtSel"></select>
        </div>

        <div class="col-3" id="districtFallbackWrap" style="display:none;">
          <label>District (manual)</label>
          <input id="districtManual" placeholder="01 or 0601">
        </div>

        <div class="col-3">
          <label>Status</label>
          <select id="status">
            <option value="Called">Called</option>
            <option value="No Decision">No Decision</option>
          </select>
        </div>
        



        <div class="col-6">
          <label>Winner</label>
          <select id="winnerSel">
            <option value="">— select a candidate —</option>
          </select>
        </div>

        <div class="col-12 row-actions">
          <button id="apply" class="btn">Apply</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 8px;font-size:16px;">Active Overrides</h3>
      <table id="ovTable">
        <thead>
          <tr>
            <th>Race</th>
            <th>Type</th>
            <th>State/District</th>
            <th>Status</th>
            <th>Winner</th>
            <th style="width:1%"></th>
          </tr>
        </thead>
        <tbody id="list">
          <tr><td class="muted" colspan="6">loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
/* ---------- Constants ---------- */
const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY","DC","PR"];
const OFFICE_LABELS = {P:"President", S:"Senate", G:"Governor", H:"House"};
const TYPE_LABELS   = {G:"General", D:"DEM Primary", R:"REP Primary"};

/* ---------- DOM ---------- */
const $ = sel => document.querySelector(sel);



function syncWinnerUI(){
  const isND = ($('#status').value === 'No Decision');
  const sel = $('#winnerSel');
  sel.disabled = isND;
  if (isND) sel.value = "";      // clear any prior choice
}
$('#status').addEventListener('change', ()=>{ syncWinnerUI(); });


/* ---------- HTTP ---------- */
async function getJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function postJSON(url, body){
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

/* ---------- UI Fillers ---------- */
function fillStates(){
  $('#stateSel').innerHTML = STATES.map(s=>`<option value="${s}">${s}</option>`).join('');
}

/* ---------- Helpers ---------- */
function currentCombo(){
  return `${$('#officeSel').value}:${$('#typeSel').value}`;
}
function currentUnit(){
  const office = $('#officeSel').value;
  const state  = $('#stateSel').value;
  if (office !== 'H') return state;
  const ddSel  = $('#districtSel');
  const manual = $('#districtManual').value.trim();
  if ($('#districtWrap').style.display !== 'none' && ddSel.value){
    return `${state}-${ddSel.value.padStart(2,'0')}`;
  }
  if (/^\d{1,2}$/.test(manual)) return `${state}-${manual.padStart(2,'0')}`;
  return manual; // raw DistrictId
}

function uniqueCandidates(rows){
  const byKey = new Map();
  for (const r of rows){
    for (const c of (r.candidates||[])){
      const name = (c.name||'').trim();
      const party = (c.party||'').trim();
      if (!name) continue;
      const k = `${name}||${party}`;
      if (!byKey.has(k)) byKey.set(k, {name, party});
    }
  }
  return Array.from(byKey.values()).sort((a,b)=>a.name.localeCompare(b.name));
}

function setWinnerOptions(list){
  const sel = $('#winnerSel');
  const prev = sel.value;
  sel.innerHTML = `<option value="">— select a candidate —</option>` +
    list.map(c => `<option value="${encodeURIComponent(JSON.stringify(c))}">${c.name} ${c.party?`(${c.party})`:''}</option>`).join('');
  if (prev) sel.value = prev;
}

/* ---------- Data-driven dropdowns ---------- */
async function populateCandidates(){
  const office = $('#officeSel').value;
  const type   = $('#typeSel').value;
  const state  = $('#stateSel').value;

  let data;
  try{
    data = await getJSON(`/cache/ru?office=${encodeURIComponent(office)}&raceTypeId=${encodeURIComponent(type)}`);
  }catch(e){
    setWinnerOptions([]); return;
  }
  const rows = data.rows || [];

  if (office === 'H'){
    const unit = currentUnit();
    let districtNum = null, districtIdKey = null;
    if (/^[A-Z]{2}-\d{2}$/.test(unit)) districtNum = unit.split('-')[1];
    else if (unit) districtIdKey = unit;

    const filtered = rows
      .filter(r => r.state === state)
      .filter(r => districtNum ? (String(r.district_num||'').padStart(2,'0') === districtNum)
                               : (districtIdKey ? (String(r.district_id||'') === districtIdKey) : false));
    setWinnerOptions(uniqueCandidates(filtered));
  } else {
    setWinnerOptions(uniqueCandidates(rows.filter(r => r.state === state)));
  }
}

async function maybeLoadDistricts(){
  const office = $('#officeSel').value;
  const type   = $('#typeSel').value;
  const state  = $('#stateSel').value;

  const wrap = $('#districtWrap');
  const fb   = $('#districtFallbackWrap');
  const dd   = $('#districtSel');

  if (office !== 'H'){
    wrap.style.display = 'none';
    fb.style.display   = 'none';
    await populateCandidates();
    return;
  }
  wrap.style.display = '';
  dd.innerHTML = '';

  try{
    const data = await getJSON(`/cache/ru?office=H&raceTypeId=${encodeURIComponent(type)}`);
    const rows = (data.rows||[]).filter(r => r.state === state);
    const uniques = Array.from(new Set(rows.map(r => (r.district_num||'').padStart(2,'0')).filter(Boolean))).sort();
    if (uniques.length){
      dd.innerHTML = uniques.map(n=>`<option value="${n}">${n}</option>`).join('');
      fb.style.display = 'none';
    }else{
      fb.style.display = '';
    }
  }catch(e){
    fb.style.display = '';
  }
  await populateCandidates();
}

/* ---------- Table Rendering ---------- */
function renderTable(items){
  const tb = $('#list');
  if (!items.length){
    tb.innerHTML = `<tr><td class="muted" colspan="6">none</td></tr>`;
    return;
  }
  tb.innerHTML = items.map(r=>{
    const [office, type] = (r.combo||'').split(':');
    const race = OFFICE_LABELS[office] || office || '';
    const typ  = TYPE_LABELS[type]     || type   || '';
    const unit = r.unit || '';
    const status = r.p?.status || '';
    const win = r.p?.winner;
    const winnerLabel = win ? `${win.name||''} ${win.party?`(${win.party})`:''}` : '';
    return `<tr>
      <td><span class="badge pill-blue">${race}</span></td>
      <td><span class="badge pill-red">${typ}</span></td>
      <td>${unit ? `<code>${unit}</code>` : ''}</td>
      <td>${status || '<span class="muted">—</span>'}</td>
      <td>${winnerLabel || '<span class="muted">—</span>'}</td>
      <td style="text-align:right;">
        <button class="btn ghost" data-combo="${r.combo}" data-unit="${unit}" onclick="deleteOne(this)">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

/* ---------- Fetch & actions ---------- */
async function refresh(){
  const out = $('#list');
  out.innerHTML = `<tr><td class="muted" colspan="6">loading…</td></tr>`;
  try{
    const d = await getJSON('/overrides');
    const rows = [];
    for (const [combo, units] of Object.entries(d.overrides || {})){
      for (const [unit, p] of Object.entries(units || {})){
        rows.push({combo, unit, p});
      }
    }
    rows.sort((a,b)=> (a.combo+a.unit).localeCompare(b.combo+b.unit));
    renderTable(rows);
  }catch(e){
    out.innerHTML = `<tr><td class="muted" colspan="6">${String(e)}</td></tr>`;
  }
}

async function applyOverride(){
  const combo = currentCombo();
  const unit  = currentUnit();
  if (!unit){ alert('Pick a state (and district for House) or enter a district id.'); return; }

  const status = $('#status').value;
  let payload = { status, sticky: true };
    if (status === 'Called') {
      const winnerVal = $('#winnerSel').value;
      if (!winnerVal){ alert('Select a winner.'); return; }
      let winner;
      try { winner = JSON.parse(decodeURIComponent(winnerVal)); }
      catch { alert('Invalid winner selection.'); return; }
      payload.winner = winner;
    }
  try{
    $('#apply').disabled = true;
    await postJSON('/overrides/upsert', { combo, unit, payload });
    await refresh();
  }catch(e){
    alert(e);
  }finally{
    $('#apply').disabled = false;
  }
}

async function deleteOne(btn){
  const combo = btn.getAttribute('data-combo');
  const unit  = btn.getAttribute('data-unit');
  if (!confirm(`Remove override ${combo} / ${unit}?`)) return;
  try{
    await postJSON('/overrides/delete', { combo, unit });
    await refresh();
  }catch(e){ alert(e); }
}

/* ---------- Wiring ---------- */
fillStates();
$('#officeSel').addEventListener('change', maybeLoadDistricts);
$('#typeSel').addEventListener('change', maybeLoadDistricts);
$('#stateSel').addEventListener('change', maybeLoadDistricts);
$('#districtSel').addEventListener('change', populateCandidates);
$('#districtManual').addEventListener('input', ()=>{ if ($('#officeSel').value==='H') populateCandidates(); });

$('#refresh').addEventListener('click', async ()=>{ await refresh(); await populateCandidates(); });
$('#apply').addEventListener('click', applyOverride);

/* Initial load */
refresh().then(maybeLoadDistricts).then(populateCandidates);
syncWinnerUI();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Election Simulator — Overrides Console</title>
<style>
  :root { --bg:#0b1220; --fg:#e9f2ff; --muted:#9fb3d1; --card:#14233d; --ok:#a5f3a5; --warn:#ffd79a; --bad:#ff9aa2; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.12);background:#0e1730;font-weight:700;display:flex;align-items:center;gap:10px}
  .wrap{display:grid;grid-template-columns:1fr 420px;gap:14px;height:calc(100% - 48px);padding:12px}
  .panel{background:var(--card);border:1px solid rgba(255,255,255,.14);border-radius:14px;display:flex;flex-direction:column;min-height:0}
  .panel h2{margin:0;padding:10px 12px;font-size:14px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,.08)}
  .body{padding:12px;overflow:auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  label{font-size:12px;color:var(--muted)}
  select,input{background:#17274a;color:var(--fg);border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:6px 8px}
  input[type=number]{width:120px}
  button{background:#1f2d50;color:var(--fg);border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:8px 12px;cursor:pointer}
  button:hover{background:#213360}
  .badge{background:#17274a;padding:4px 10px;border-radius:999px;font-size:12px}
  .mono{font-family:ui-monospace,monospace;font-size:12px}
  .list{display:grid;gap:8px}
  .item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:8px 10px}
</style>
</head>
<body>
  <header>
    <div>Election Simulator — Overrides Console</div>
    <span id="status" class="badge">loading…</span>
    <a class="badge" href="/metrics" target="_blank">metrics</a>
    <a class="badge" href="/api/ping" target="_blank">ping</a>
  </header>

  <div class="wrap">
    <section class="panel">
      <h2>Set Override — President (County)</h2>
      <div class="body">
        <div class="row">
          <label for="stateSel">State</label>
          <select id="stateSel"></select>

          <label for="countySel">County</label>
          <select id="countySel" style="min-width:280px"></select>
        </div>

        <div class="row">
          <label for="rep">REP</label>
          <input id="rep" type="text" min="0" step="1" placeholder="e.g. 120345" />
          <label for="dem">DEM</label>
          <input id="dem" type="text" min="0" step="1" placeholder="e.g. 118903" />
          <label for="ind">IND</label>
          <input id="ind" type="text" min="0" step="1" placeholder="e.g. 8901" />
        </div>

        <div class="row">
          <button id="applyBtn">Apply Override</button>
          <button id="removeBtn">Remove Override</button>
          <button id="clearAllBtn" title="Remove every county override">Clear ALL Overrides</button>
          <span id="msg" class="mono"></span>
        </div>

        <div class="row">
          <button id="previewBtn" title="Fetch current XML to confirm override is applied">Preview /v2/elections</button>
          <span class="mono">Opens in a new tab for the chosen state.</span>
        </div>
      </div>
    </section>

    <aside class="panel">
      <h2>Current Overrides</h2>
      <div class="body">
        <div id="ovrList" class="list"></div>
      </div>
    </aside>
  </div>

<script>
const statusEl = document.getElementById('status');
const stateSel = document.getElementById('stateSel');
const countySel= document.getElementById('countySel');
const repEl    = document.getElementById('rep');
const demEl    = document.getElementById('dem');
const indEl    = document.getElementById('ind');
const msgEl    = document.getElementById('msg');
const ovrList  = document.getElementById('ovrList');

function fmt(n){ return String(n); }


async function api(url, opts){
  try{
    const r = await fetch(url, Object.assign({cache:'no-store'}, opts||{}));
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const ct = r.headers.get('content-type') || '';
    if(ct.includes('application/json')) return await r.json();
    return await r.text();
  }catch(e){
    msgEl.textContent = 'Error: '+e.message;
    throw e;
  }
}

async function loadStates(){
  const states = await api('/registry/states');
  stateSel.innerHTML = states.map(s=>`<option value="${s}">${s}</option>`).join('');
  if(states.length){ await loadCounties(states[0]); }
}

async function loadCounties(state){
  const counties = await api('/registry/counties?state='+encodeURIComponent(state));
  countySel.innerHTML = counties.map(c=>`<option value="${c.fips}">${c.fips} — ${c.name}</option>`).join('');
}

stateSel.onchange = async () => { await loadCounties(stateSel.value); };

document.getElementById('applyBtn').onclick = async () => {
  const fips = countySel.value;
  const rep = repEl.value;  // allow letters or numbers
  const dem = demEl.value;
  const ind = indEl.value;

  // skip numeric validation — send raw strings to the API
  const res = await api('/override/county', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ fips, rep, dem, ind })
  });
  msgEl.textContent = 'Override saved for FIPS '+fips+': REP '+fmt(rep)+', DEM '+fmt(dem)+', IND '+fmt(ind);
  await refreshOverrides();
};

document.getElementById('removeBtn').onclick = async () => {
  const fips = countySel.value;
  await api('/override/county?fips='+encodeURIComponent(fips), { method:'DELETE' });
  msgEl.textContent = 'Override removed for FIPS '+fips;
  await refreshOverrides();
};

document.getElementById('clearAllBtn').onclick = async () => {
  if(!confirm('Clear ALL county overrides?')) return;
  await api('/overrides', { method:'DELETE' });
  msgEl.textContent = 'All overrides cleared.';
  await refreshOverrides();
};

document.getElementById('previewBtn').onclick = () => {
  const st = stateSel.value || 'CA';
  const url = `/v2/elections/2024-11-05?statepostal=${st}&raceTypeId=G&raceId=0&level=ru&officeId=P`;
  window.open(url, '_blank');
};

async function refreshOverrides(){
  const j = await api('/overrides');
  const rows = Object.entries(j.counties || {});
  if(!rows.length){
    ovrList.innerHTML = '<div class="mono">No overrides set.</div>';
    return;
  }
  ovrList.innerHTML = rows.map(([fips, v]) => {
    return `<div class="item mono">FIPS ${fips}: REP ${fmt(v.REP)} • DEM ${fmt(v.DEM)} • IND ${fmt(v.IND)}</div>`;
  }).join('');
}

async function heartbeat(){
  try{
    const m = await api('/metrics');
    statusEl.textContent = `rpm=${m.calls_per_minute} • total=${m.total_calls}`;
  }catch(_){}
}

loadStates().then(refreshOverrides);
setInterval(heartbeat, 1000);
</script>
</body>
</html>
